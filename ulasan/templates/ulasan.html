{% extends 'base.html' %}

{% block content %}
    <div class="container mt-5">
        <div class="card">
            <div class="card-body">
                <h1 class="card-title">Informasi Buku</h1>
                <h2>Judul: {{ book.title }}</h2>
                <p>Genre: {{ book.genre }}</p>
                <p>Ringkasan: {{ book.summary }}</p>
                <a href="{% url 'beranda:show_peminjaman_buku' %}">
                    <button>
                        Back
                    </button>
                </a>
            </div>
        </div>

        <h3>Ulasan Pengguna</h3>
        <div id="user-reviews"></div>

        <!-- Formulir untuk menambahkan ulasan -->
        <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="reviewModalLabel">Tambahkan Ulasan Anda</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Isi formulir untuk menambahkan ulasan -->
                        <form id="review_form_modal" method="post">
                            {% csrf_token %}
                            <label for="user_name_modal">Nama Anda:</label>
                            <input type="text" id="user_name_modal" name="user_name" required>
                            <label for="rating_modal">Rating:</label>
                            <select id="rating_modal" name="rating" required>
                                <option value="5">★★★★★</option>
                                <option value="4">★★★★☆</option>
                                <option value="3">★★★☆☆</option>
                                <option value="2">★★☆☆☆</option>
                                <option value="1">★☆☆☆☆</option>
                            </select>
                            <label for="review_text_modal">Ulasan Anda:</label>
                            <textarea id="review_text_modal" name="review_text" required></textarea>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                        <button type="button" class="btn btn-primary" id="submit_review" data-bs-dismiss="modal">Kirim Ulasan</button>
                    </div>
                </div>
            </div>
        </div>

        <button type="button" class="btn custom-btn-color" data-bs-toggle="modal" data-bs-target="#reviewModal" style="background-color: #8b659a; color: #ffffff; padding: 5px 15px; border: none; border-radius: 5px; margin-right: 5px;">
            Add Review by AJAX
        </button>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const bookId = "{{ book.id }}";
                console.log("Book ID:", bookId); // cek value

                if (bookId) {
                    async function getReviews() {
                        return fetch(`/get-reviews-json/${bookId}/`).then((res) => res.json());
                    }

                    async function refreshReviews() {
                        const reviewContainer = document.getElementById("user-reviews");
                        reviewContainer.innerHTML = "Loading reviews...";

                        const reviews = await getReviews();
                        let htmlString = "";

                        reviews.forEach((review) => {
                            htmlString += `
                                <li>
                                    <p>Oleh: ${review.fields.user_name}</p>
                                    <p>Rating: ${review.fields.rating} out of 5</p>
                                    <p>Ulasan: ${review.fields.review_text}</p>
                                    <p>Date Added: ${review.fields.date_added}</p>
                                </li>`;
                        });

                        reviewContainer.innerHTML = htmlString;
                    }

                    const reviewForm = document.getElementById("review_form_modal");

                    reviewForm.addEventListener("submit", async function (event) {
                        event.preventDefault(); // Mencegah pengiriman formulir otomatis

                        const user_name = document.getElementById("user_name_modal").value;
                        const rating = document.getElementById("rating_modal").value;
                        const review_text = document.getElementById("review_text_modal").value;
                        const currentDate = new Date();
                        const date_added = currentDate.toISOString();
                        const data = {
                            user_name: user_name,
                            rating: rating,
                            review_text: review_text,
                            date_added: date_added,
                        };

                        // Kirim permintaan POST ke endpoint yang sesuai
                        try {
                            const response = await fetch(`/add-review/${bookId}/`, {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": getCookie("csrftoken"), // Ambil token CSRF
                                },
                                body: JSON.stringify(data),
                            });

                            if (response.status === 201) {
                                // Ulasan berhasil ditambahkan
                                refreshReviews();
                                const reviewModal = new bootstrap.Modal(document.getElementById("reviewModal"));
                                reviewModal.hide();
                            } else {
                                console.error("Gagal menambahkan ulasan.");
                            }
                        } catch (error) {
                            console.error("Kesalahan dalam pengiriman permintaan: ", error);
                        }
                    });

                    refreshReviews(); // Untuk memuat ulasan saat halaman dimuat
                }
            });
        </script>
    </div>
{% endblock content %}
