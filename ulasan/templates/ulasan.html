{% extends 'base.html' %}

{% block content %}
    <div class="container mt-5">
        <div class="card">
            <div class="card-body">
                <h1 class="card-title">Informasi Buku</h1>
                <h2>Judul: {{ book.title }}</h2>
                <p>Genre: {{ book.genre }}</p>
                <p>Ringkasan: {{ book.summary }}</p>
            </div>
        </div>

        <h3>Ulasan Pengguna</h3>
        {% for review in reviews %}
        <div id="user-review">
            <p>Oleh: {{ review.user_name }}</p>
            <p>Rating: {{ review.rating }} out of 5</p>
            <p>Ulasan: {{ review.review_text }}</p>
            <p>Waktu Review: {{ review.date_added }}</p>

            {% if user.is_authenticated and user.username == review.user_name %}
                <a href="{% url 'ulasan:edit_review' review.id %}">Edit Review</a>
                <a href="{% url 'ulasan:delete_review' review.id %}">Delete Review</a>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <select name="buku" id="buku" class="form-control" size="0">
        {% for book in books %}
            <option value=""{{ book.pk }}>{{ book.title }}</option>
            {% endfor %}
    </select>
    <!-- Formulir untuk menambahkan ulasan -->
    <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reviewModalLabel">Tambahkan Ulasan Anda</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Isi formulir untuk menambahkan ulasan -->
                    <form id="review_form_modal" method="post">
                        {% csrf_token %}
                        <label for="user_name_modal">Nama Anda:</label>
                        <input type="text" id="user_name_modal" name="user_name" required>
                        <label for="rating_modal">Rating:</label>
                        <select id="rating_modal" name="rating" required>
                            <option value="5">★★★★★</option>
                            <option value="4">★★★★☆</option>
                            <option value="3">★★★☆☆</option>
                            <option value="2">★★☆☆☆</option>
                            <option value="1">★☆☆☆☆</option>
                        </select>
                        <label for="review_text_modal">Ulasan Anda:</label>
                        <textarea id="review_text_modal" name="review_text" required></textarea>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" id="submit_review" data-bs-dismiss="modal">Kirim Ulasan</button>
                </div>
            </div>
        </div>
    </div>
    <button type="button" class="btn custom-btn-color" data-bs-toggle="modal" data-bs-target="#reviewModal" style="background-color: #8b659a; color: #ffffff; padding: 5px 15px; border: none; border-radius: 5px; margin-right: 5px;">
        Add Review by AJAX
    </button>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const bookId = "{{ book.id }}";
    console.log("Book ID:", bookId); // Add this line to check the value

    if (bookId) {
        async function getReviews() {
            return fetch(`/reviews-json/${bookId}/`).then((res) => res.json());
        }

        async function refreshReviews() {
            const reviewContainer = document.getElementById("user-reviews");
            reviewContainer.innerHTML = "Loading reviews...";

            const reviews = await getReviews();
            let htmlString = "<ul>";

            reviews.forEach((review) => {
                htmlString += `
                    <li>
                        <p>Oleh: ${review.fields.user_name}</p>
                        <p>Rating: ${review.fields.rating} out of 5</p>
                        <p>Ulasan: ${review.fields.review_text}</p>
                        <p>Date Added: ${review.fields.date_added}</p>
                    </li>`;
            });

            htmlString += "</ul>";
            reviewContainer.innerHTML = htmlString;
        }

        const reviewForm = document.getElementById("review_form");

        reviewForm.addEventListener("submit", async function (event) {
            event.preventDefault(); // Mencegah pengiriman formulir otomatis

            const user_name = document.getElementById("user_name").value;
            const rating = document.getElementById("rating").value;
            const review_text = document.getElementById("review_text").value;
            const currentDate = new Date();
            const date_added = currentDate.toISOString();
            const data = {
                user_name: user_name,
                rating: rating,
                review_text: review_text,
                date_added: date_added,
            };

            // Kirim permintaan POST ke endpoint yang sesuai
            try {
                const response = await fetch(`/add-review/${bookId}/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken"), // Ambil token CSRF
                    },
                    body: JSON.stringify(data),
                });

                if (response.status === 201) {
                    // Ulasan berhasil ditambahkan, Anda dapat memuat ulasan lagi atau melakukan tindakan lain
                    refreshReviews();
                    const reviewModal = new bootstrap.Modal(document.getElementById("reviewModal"));
                    reviewModal.hide();
                } else {
                    console.error("Gagal menambahkan ulasan.");
                }
            } catch (error) {
                console.error("Kesalahan dalam pengiriman permintaan: ", error);
            }
        });

        refreshReviews(); // Untuk memuat ulasan saat halaman dimuat

        function addReview() {
            const url = "/ulasan/add-review/" + bookId + "/";
            fetch(url, {
                method: "POST",
                body: new FormData(document.querySelector('#review_form_modal'))
            }).then(refreshReviews)

            document.getElementById("review_form_modal").reset()
            return false
        }

        
        document.getElementById("submit_review").onclick = addProduct
    }
});

</script>
{% endblock content %}